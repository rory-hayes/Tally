<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Tally – Post-MVP Roadmap (Milestones 10–12)</title>
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; max-width: 960px; margin: 2rem auto; line-height: 1.5; }
    h1, h2, h3 { margin-top: 1.5rem; }
    details { margin-bottom: 1rem; border: 1px solid #ddd; border-radius: 6px; padding: 0.75rem 1rem; }
    summary { font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; }
    .done-label { font-size: 0.9rem; color: #555; }
    pre { background: #f7f7f7; padding: 0.75rem; border-radius: 4px; overflow: auto; font-size: 0.85rem; }
    code { font-family: Menlo, Monaco, Consolas, "Courier New", monospace; }
    ul { margin-top: 0.5rem; }
    li { margin-bottom: 0.25rem; }
  </style>
</head>
<body>
  <h1>Tally – Post-MVP Roadmap</h1>
  <p>This roadmap defines Milestones 10 through 12, based on QA results from the live MVP and aligned with upcoming production readiness.</p>

  <h2>Milestone 10 – Hardening, Bugfixes & UI Polish</h2>

  <details>
    <summary>M10.1 – Fix missing rule triggers (USC spike, Pension %, PRSI/NI category)</summary>
    <h4>Prompt for Cursor</h4>
    <pre><code>// Goal: Ensure all defined rules in runRules() are correctly invoked and result in issue creation.

// Fix rules that are currently not triggering:
// - USC/NI spike (threshold >20%)
// - Pension % (EE >=12%, ER >=12%)
// - PRSI or NI category change

// Before you start:
// - Use the synthetic payslips (EMP003, EMP005) to validate fix.
// - Ensure normalisation step extracts usc_ni, pension_employee, pension_employer, prsi_category fields.

// Definition of Done:
// - EMP003 triggers usc_spike
// - EMP005 triggers pension_over_threshold
// - EMP with PRSI change triggers info issue (if supported in test data)
// - Unit tests confirm each rule fires under expected inputs.
    </code></pre>
  </details>

  <details>
    <summary>M10.2 – Fix pay date source on Employee Detail view</summary>
    <h4>Prompt for Cursor</h4>
    <pre><code>// Goal: Display the correct payslip pay date on the employee diff view.

// Issue: Currently shows today's date (new Date()), not the actual period.
// Fix:
// - Update the payslip ingestion logic to extract and store the correct pay date (if possible)
// - Alternatively, fall back to batch.period_label or a derived date from the payslip.

// Definition of Done:
// - Employee view shows accurate pay dates (e.g. 2025-01 and 2025-02)
// - Unit test verifies the displayed value matches stored data.
    </code></pre>
  </details>

  <details>
    <summary>M10.3 – Fix batch + dashboard issue counts</summary>
    <h4>Prompt for Cursor</h4>
    <pre><code>// Goal: Ensure issue counts by severity are accurate across batch and dashboard views.

// Symptoms:
// - EMP003 shows 0 warnings in batch table, but should show 1.
// - Batch summary card counts may mismatch actual inserted issues.

// Fix:
// - Re-query issues table correctly with severity filters.
// - Re-validate aggregation logic for employees.

// Definition of Done:
// - Dashboard shows accurate issue summary per client
// - Batch detail summary shows correct critical/warning/info totals
// - Employee row shows accurate per-employee issue counts
// - Add tests for issue aggregation functions with synthetic data
    </code></pre>
  </details>

  <details>
    <summary>M10.4 – Improve Upload & Processing Feedback</summary>
    <h4>Prompt for Cursor</h4>
    <pre><code>// Goal: Improve UX around file upload and batch processing visibility.

// Requirements:
// - Fix bug where file picker opens and causes 404
// - After upload: show confirmation (toast), disable re-click
// - While processing: show a spinner or message in Batch UI
// - If a job fails: display that X/Y files processed and which failed

// Definition of Done:
// - Upload UI never navigates away (404 bug fixed)
// - Toast confirms upload + job creation
// - Batch page displays progress and handles partial failure
// - UI tests simulate each of these paths with mocked state
    </code></pre>
  </details>

  <details>
    <summary>M10.5 – Fix issue resolution & table refresh logic</summary>
    <h4>Prompt for Cursor</h4>
    <pre><code>// Goal: Ensure marking issues as resolved updates both UI and database correctly.

// Fix:
// - After resolving/unresolving, batch employee table should refresh
// - Employee issue count should reflect resolved/unresolved status

// Definition of Done:
// - Marking an issue as resolved reflects immediately in batch summary
// - Resolved issue still visible (greyed, struck through)
// - Unresolved issues update counts appropriately
// - Add tests for resolution toggle effect on state
    </code></pre>
  </details>

  <h2>Milestone 11 – Pre-Launch Enhancements</h2>

  <details>
    <summary>M11.1 – Implement audit log tracking for key actions</summary>
    <h4>Prompt for Cursor</h4>
    <pre><code>// Goal: Begin writing to audit_logs table for traceability.

// Events to log:
// - Batch created
// - Payslips uploaded
// - Issues marked resolved/unresolved

// Definition of Done:
// - Each action creates audit_log row with actor, action_type, metadata, and timestamp
// - Metadata includes batch ID, employee ID, or issue ID as applicable
// - DB test confirms row inserted for each case
    </code></pre>
  </details>

  <details>
    <summary>M11.2 – Store and display resolved_by user + timestamp</summary>
    <h4>Prompt for Cursor</h4>
    <pre><code>// Goal: Populate resolved_by and resolved_at in issues when marked resolved.

// Update:
// - Extend resolution mutation to capture user ID and timestamp
// - Display on issue tooltip: "Resolved by [user] on [date/time]"

// Definition of Done:
// - Resolved issues show tooltip with user + date
// - DB row contains resolved_by, resolved_at
// - Manual test confirms resolution attribution is recorded
    </code></pre>
  </details>

  <details>
    <summary>M11.3 – Surface failed payslip jobs in UI</summary>
    <h4>Prompt for Cursor</h4>
    <pre><code>// Goal: Make failed jobs visible in the batch view for troubleshooting.

// When a job fails:
// - It should not silently be skipped
// - UI should show a badge or warning e.g. "9 of 10 processed – 1 failed"

// Definition of Done:
// - Failed jobs appear in the batch file summary
// - Employee count reflects only successful payslips
// - User can see which file(s) failed
    </code></pre>
  </details>

  <details>
    <summary>M11.4 – YTD and PRSI field extraction</summary>
    <h4>Prompt for Cursor</h4>
    <pre><code>// Goal: Extend Textract normalization to extract:
// - YTD gross/net/PAYE/USC
// - PRSI or NI category

// Update:
// - Add regex patterns to match YTD values from OCR text
// - Store in payslip fields ytd_* and prsi_or_ni_category

// Definition of Done:
// - EMP payslips parse and store YTD values where present
// - PRSI category field populated from OCR
// - Unit test confirms correct values extracted from representative OCR lines
    </code></pre>
  </details>

  <details>
    <summary>M11.5 – Add employee count to client list and batch</summary>
    <h4>Prompt for Cursor</h4>
    <pre><code>// Goal: Show number of employees processed per batch and per client.

// Client page:
// - Add "Employees processed" column
// Batch table:
// - Show employee count once payslips are processed

// Definition of Done:
// - Employee count appears for each batch row
// - Client list aggregates unique employees across all batches
// - Test for aggregation logic with mocked data
    </code></pre>
  </details>

</body>
</html>
